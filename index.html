<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRC² — Thalamically Routed Cortical Columns</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Mono:wght@300;400;500&family=Space+Grotesk:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════
   CSS CUSTOM PROPERTIES — THEME SYSTEM
   ═══════════════════════════════════════════════════ */
:root {
  --font-display: 'Instrument Serif', Georgia, serif;
  --font-body: 'Space Grotesk', system-ui, sans-serif;
  --font-mono: 'DM Mono', 'Courier New', monospace;
  --font-accent: 'Playfair Display', Georgia, serif;

  /* Shared accent palette */
  --thalamus: #ff6b35;
  --cortex: #4ecdc4;
  --cerebellum: #45b7d1;
  --hippocampus: #a78bfa;
  --neuromod: #f472b6;
  --predictive: #fbbf24;
  --dendrite: #34d399;
  --glow-thalamus: rgba(255, 107, 53, 0.4);
  --glow-cortex: rgba(78, 205, 196, 0.4);
  --glow-cerebellum: rgba(69, 183, 209, 0.4);

  --transition-speed: 0.5s;
  --easing: cubic-bezier(0.16, 1, 0.3, 1);
}

/* DARK THEME */
[data-theme="dark"] {
  --bg-primary: #0a0a0f;
  --bg-secondary: #12121a;
  --bg-card: #1a1a28;
  --bg-card-hover: #222236;
  --bg-code: #161625;
  --text-primary: #e8e6e3;
  --text-secondary: #9ca3af;
  --text-muted: #6b7280;
  --border-color: rgba(255,255,255,0.06);
  --border-accent: rgba(255,255,255,0.12);
  --shadow-card: 0 4px 60px rgba(0,0,0,0.5);
  --gradient-hero: linear-gradient(160deg, #0a0a0f 0%, #1a0a20 30%, #0a1a2f 60%, #0a0a0f 100%);
  --gradient-section: linear-gradient(180deg, transparent, rgba(78,205,196,0.02), transparent);
  --noise-opacity: 0.03;
  --overlay-grid: rgba(255,255,255,0.015);
  --equation-bg: rgba(255,255,255,0.03);
  --table-header: rgba(78,205,196,0.08);
  --table-row-alt: rgba(255,255,255,0.02);
  --particle-color: rgba(255,255,255,0.3);
}

/* LIGHT THEME */
[data-theme="light"] {
  --bg-primary: #faf8f5;
  --bg-secondary: #f0ede8;
  --bg-card: #ffffff;
  --bg-card-hover: #f8f6f3;
  --bg-code: #f5f3ef;
  --text-primary: #1a1a2e;
  --text-secondary: #4a5568;
  --text-muted: #718096;
  --border-color: rgba(0,0,0,0.06);
  --border-accent: rgba(0,0,0,0.12);
  --shadow-card: 0 4px 40px rgba(0,0,0,0.08);
  --gradient-hero: linear-gradient(160deg, #faf8f5 0%, #f0e6f6 30%, #e6f0f8 60%, #faf8f5 100%);
  --gradient-section: linear-gradient(180deg, transparent, rgba(78,205,196,0.04), transparent);
  --noise-opacity: 0.015;
  --overlay-grid: rgba(0,0,0,0.02);
  --equation-bg: rgba(0,0,0,0.03);
  --table-header: rgba(78,205,196,0.1);
  --table-row-alt: rgba(0,0,0,0.02);
  --particle-color: rgba(0,0,0,0.15);
}

/* ═══════════════════════════════════════════════════
   GLOBAL RESET & BASE
   ═══════════════════════════════════════════════════ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

html {
  scroll-behavior: smooth;
  font-size: 16px;
  -webkit-font-smoothing: antialiased;
}

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--font-body);
  line-height: 1.7;
  transition: background var(--transition-speed) var(--easing),
              color var(--transition-speed) var(--easing);
  overflow-x: hidden;
}

/* Noise texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  opacity: var(--noise-opacity);
  pointer-events: none;
  z-index: 9999;
}

::selection {
  background: var(--cortex);
  color: #0a0a0f;
}

a { color: var(--cortex); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ═══════════════════════════════════════════════════
   THEME TOGGLE
   ═══════════════════════════════════════════════════ */
.theme-toggle {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 1000;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: 1px solid var(--border-accent);
  background: var(--bg-card);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s var(--easing);
  backdrop-filter: blur(20px);
  box-shadow: var(--shadow-card);
}
.theme-toggle:hover {
  transform: scale(1.1) rotate(15deg);
  border-color: var(--cortex);
}
.theme-toggle svg {
  width: 22px; height: 22px;
  fill: var(--text-primary);
  transition: fill var(--transition-speed);
}
.theme-toggle .sun { display: none; }
[data-theme="light"] .theme-toggle .moon { display: none; }
[data-theme="light"] .theme-toggle .sun { display: block; }

/* ═══════════════════════════════════════════════════
   NAVIGATION
   ═══════════════════════════════════════════════════ */
.nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 900;
  padding: 16px 32px;
  display: flex;
  align-items: center;
  gap: 24px;
  background: rgba(10,10,15,0.6);
  backdrop-filter: blur(30px) saturate(1.5);
  border-bottom: 1px solid var(--border-color);
  transform: translateY(-100%);
  transition: transform 0.5s var(--easing), background 0.5s;
}
[data-theme="light"] .nav {
  background: rgba(250,248,245,0.7);
}
.nav.visible { transform: translateY(0); }
.nav-logo {
  font-family: var(--font-display);
  font-size: 1.3rem;
  color: var(--cortex);
  white-space: nowrap;
}
.nav-links {
  display: flex; gap: 20px;
  list-style: none;
  margin-left: auto;
  margin-right: 72px;
}
.nav-links a {
  font-size: 0.82rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--text-secondary);
  transition: color 0.3s;
}
.nav-links a:hover { color: var(--cortex); text-decoration: none; }

/* ═══════════════════════════════════════════════════
   LAYOUT
   ═══════════════════════════════════════════════════ */
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 0 32px;
}
.wide-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 32px;
}

/* ═══════════════════════════════════════════════════
   HERO SECTION
   ═══════════════════════════════════════════════════ */
.hero {
  position: relative;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  background: var(--gradient-hero);
  overflow: hidden;
  padding: 80px 32px;
}

/* Animated neural network canvas */
#neural-canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  opacity: 0.35;
}

.hero-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 20px;
  border-radius: 100px;
  border: 1px solid var(--border-accent);
  background: var(--bg-card);
  font-family: var(--font-mono);
  font-size: 0.75rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--cortex);
  margin-bottom: 40px;
  animation: fadeSlideUp 1s 0.2s var(--easing) both;
}
.hero-badge::before {
  content: '';
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--cortex);
  animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.7); }
}

.hero h1 {
  font-family: var(--font-display);
  font-size: clamp(3.2rem, 8vw, 7rem);
  line-height: 1.05;
  letter-spacing: -0.03em;
  max-width: 900px;
  animation: fadeSlideUp 1s 0.4s var(--easing) both;
}

.hero h1 .accent {
  background: linear-gradient(135deg, var(--thalamus), var(--cortex));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero-subtitle {
  font-family: var(--font-accent);
  font-style: italic;
  font-size: clamp(1.1rem, 2.5vw, 1.5rem);
  color: var(--text-secondary);
  max-width: 700px;
  margin-top: 28px;
  animation: fadeSlideUp 1s 0.6s var(--easing) both;
}

.hero-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  justify-content: center;
  margin-top: 48px;
  animation: fadeSlideUp 1s 0.8s var(--easing) both;
}

.hero-meta-item {
  font-family: var(--font-mono);
  font-size: 0.78rem;
  color: var(--text-muted);
  letter-spacing: 0.05em;
}
.hero-meta-item strong {
  color: var(--text-primary);
  font-weight: 500;
}

.hero-scroll-hint {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  animation: fadeSlideUp 1s 1.2s var(--easing) both;
}
.hero-scroll-hint span {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-muted);
}
.scroll-line {
  width: 1px; height: 40px;
  background: linear-gradient(to bottom, var(--cortex), transparent);
  animation: scroll-pulse 2s infinite;
}
@keyframes scroll-pulse {
  0% { opacity: 1; transform: scaleY(1); }
  50% { opacity: 0.3; transform: scaleY(0.5); }
  100% { opacity: 1; transform: scaleY(1); }
}

@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(40px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ═══════════════════════════════════════════════════
   SECTION STYLING
   ═══════════════════════════════════════════════════ */
section {
  padding: 100px 0;
  position: relative;
}

.section-label {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--cortex);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.section-label::before {
  content: '';
  width: 32px; height: 1px;
  background: var(--cortex);
}

.section-title {
  font-family: var(--font-display);
  font-size: clamp(2rem, 4vw, 3.2rem);
  line-height: 1.15;
  letter-spacing: -0.02em;
  margin-bottom: 32px;
}

.section-body {
  color: var(--text-secondary);
  font-size: 1.05rem;
  line-height: 1.8;
  max-width: 720px;
}
.section-body p + p {
  margin-top: 20px;
}

/* ═══════════════════════════════════════════════════
   ANIMATED BRAIN COMPONENT CARDS
   ═══════════════════════════════════════════════════ */
.components-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 24px;
  margin-top: 56px;
}

.comp-card {
  position: relative;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 36px;
  overflow: hidden;
  transition: all 0.5s var(--easing);
  cursor: default;
}
.comp-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--card-accent, var(--cortex));
  opacity: 0;
  transition: opacity 0.4s;
}
.comp-card:hover::before { opacity: 1; }
.comp-card:hover {
  transform: translateY(-4px);
  border-color: var(--border-accent);
  box-shadow: var(--shadow-card);
}

.comp-icon {
  width: 72px;
  height: 72px;
  margin-bottom: 20px;
  position: relative;
}
.comp-icon svg {
  width: 100%;
  height: 100%;
}

.comp-card h3 {
  font-family: var(--font-display);
  font-size: 1.35rem;
  margin-bottom: 12px;
}
.comp-card p {
  color: var(--text-secondary);
  font-size: 0.92rem;
  line-height: 1.65;
}
.comp-card .comp-tag {
  display: inline-block;
  margin-top: 16px;
  font-family: var(--font-mono);
  font-size: 0.68rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 4px 12px;
  border-radius: 100px;
  border: 1px solid var(--border-accent);
  color: var(--text-muted);
}

/* ═══════════════════════════════════════════════════
   ARCHITECTURE DIAGRAM SECTION
   ═══════════════════════════════════════════════════ */
.arch-section {
  background: var(--gradient-section);
}

.arch-diagram-wrap {
  position: relative;
  margin: 48px auto;
  max-width: 900px;
}

.arch-flow {
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: center;
}

.arch-node {
  position: relative;
  width: 100%;
  max-width: 640px;
  padding: 20px 28px;
  border-radius: 14px;
  border: 1px solid var(--border-color);
  background: var(--bg-card);
  font-size: 0.9rem;
  transition: all 0.4s var(--easing);
  overflow: hidden;
}
.arch-node:hover {
  border-color: var(--node-color, var(--border-accent));
  box-shadow: 0 0 40px rgba(78,205,196,0.08);
  transform: scale(1.01);
}
.arch-node-label {
  font-family: var(--font-mono);
  font-size: 0.68rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.arch-node-label .dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  display: inline-block;
}
.arch-node-title {
  font-family: var(--font-display);
  font-size: 1.15rem;
  margin-bottom: 4px;
}
.arch-node-desc {
  font-size: 0.82rem;
  color: var(--text-secondary);
  font-family: var(--font-mono);
}

.arch-arrow {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 36px;
  position: relative;
}
.arch-arrow::before {
  content: '';
  width: 1px; height: 28px;
  background: linear-gradient(to bottom, var(--border-accent), var(--cortex));
  animation: flow-down 2s infinite linear;
}
.arch-arrow::after {
  content: '';
  width: 8px; height: 8px;
  border-right: 1px solid var(--cortex);
  border-bottom: 1px solid var(--cortex);
  transform: rotate(45deg);
  margin-top: -4px;
}
@keyframes flow-down {
  0% { opacity: 0.3; }
  50% { opacity: 1; }
  100% { opacity: 0.3; }
}

/* ═══════════════════════════════════════════════════
   EQUATIONS
   ═══════════════════════════════════════════════════ */
.equation-block {
  background: var(--equation-bg);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 24px 32px;
  margin: 24px 0;
  font-family: var(--font-mono);
  font-size: 0.88rem;
  overflow-x: auto;
  position: relative;
}
.equation-block::before {
  content: attr(data-eq);
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.72rem;
  color: var(--text-muted);
}

/* ═══════════════════════════════════════════════════
   TABLES
   ═══════════════════════════════════════════════════ */
.results-table-wrap {
  overflow-x: auto;
  margin: 32px 0;
  border-radius: 16px;
  border: 1px solid var(--border-color);
  background: var(--bg-card);
}
.results-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.88rem;
}
.results-table th {
  font-family: var(--font-mono);
  font-size: 0.72rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  text-align: left;
  padding: 16px 20px;
  background: var(--table-header);
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border-color);
  white-space: nowrap;
}
.results-table td {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border-color);
  white-space: nowrap;
}
.results-table tr:nth-child(even) td {
  background: var(--table-row-alt);
}
.results-table .highlight-row td {
  color: var(--cortex);
  font-weight: 600;
}
.results-table .best-val {
  color: var(--cortex);
  font-weight: 600;
}

/* ═══════════════════════════════════════════════════
   ANIMATED BRAIN SVG ICONS
   ═══════════════════════════════════════════════════ */
@keyframes neuron-pulse {
  0%, 100% { r: 3; opacity: 0.8; }
  50% { r: 5; opacity: 1; }
}
@keyframes synapse-fire {
  0% { stroke-dashoffset: 30; opacity: 0.3; }
  50% { stroke-dashoffset: 0; opacity: 1; }
  100% { stroke-dashoffset: -30; opacity: 0.3; }
}
@keyframes rotate-slow {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
@keyframes orbit {
  from { transform: rotate(0deg) translateX(22px) rotate(0deg); }
  to { transform: rotate(360deg) translateX(22px) rotate(-360deg); }
}

.icon-animated circle.pulse {
  animation: neuron-pulse 2s ease-in-out infinite;
}
.icon-animated line.synapse {
  stroke-dasharray: 15;
  animation: synapse-fire 1.5s ease-in-out infinite;
}

/* ═══════════════════════════════════════════════════
   BAR CHART VIS
   ═══════════════════════════════════════════════════ */
.chart-container {
  margin: 40px 0;
  padding: 32px;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 16px;
}
.chart-title {
  font-family: var(--font-mono);
  font-size: 0.72rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 24px;
}
.chart-bars {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.chart-bar-row {
  display: flex;
  align-items: center;
  gap: 16px;
}
.chart-bar-label {
  width: 120px;
  font-family: var(--font-mono);
  font-size: 0.78rem;
  text-align: right;
  color: var(--text-secondary);
  flex-shrink: 0;
}
.chart-bar-track {
  flex: 1;
  height: 28px;
  background: var(--equation-bg);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}
.chart-bar-fill {
  height: 100%;
  border-radius: 6px;
  transition: width 1.5s var(--easing);
  position: relative;
}
.chart-bar-fill::after {
  content: attr(data-val);
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-family: var(--font-mono);
  font-size: 0.7rem;
  font-weight: 600;
  color: #0a0a0f;
}
.chart-bar-fill.trc2 { background: linear-gradient(90deg, var(--cortex), var(--thalamus)); }
.chart-bar-fill.transformer { background: linear-gradient(90deg, #6b7280, #9ca3af); }
.chart-bar-fill.mamba { background: linear-gradient(90deg, #4b5563, #6b7280); }

/* ═══════════════════════════════════════════════════
   CONTRIBUTION CARDS
   ═══════════════════════════════════════════════════ */
.contrib-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-top: 48px;
}
@media (max-width: 768px) {
  .contrib-grid { grid-template-columns: 1fr; }
}
.contrib-card {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 32px;
  position: relative;
  transition: all 0.4s var(--easing);
}
.contrib-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-card);
}
.contrib-num {
  font-family: var(--font-display);
  font-size: 3.5rem;
  line-height: 1;
  background: linear-gradient(135deg, var(--cortex), transparent);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 16px;
  opacity: 0.6;
}
.contrib-card h3 {
  font-family: var(--font-display);
  font-size: 1.15rem;
  margin-bottom: 12px;
}
.contrib-card p {
  font-size: 0.88rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

/* ═══════════════════════════════════════════════════
   FOOTER
   ═══════════════════════════════════════════════════ */
.footer {
  padding: 60px 0;
  text-align: center;
  border-top: 1px solid var(--border-color);
}
.footer p {
  font-family: var(--font-mono);
  font-size: 0.78rem;
  color: var(--text-muted);
}

/* ═══════════════════════════════════════════════════
   SCROLL ANIMATIONS
   ═══════════════════════════════════════════════════ */
.reveal {
  opacity: 0;
  transform: translateY(30px);
  transition: opacity 0.8s var(--easing), transform 0.8s var(--easing);
}
.reveal.visible {
  opacity: 1;
  transform: translateY(0);
}

/* Stagger children */
.stagger-children > * {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.6s var(--easing), transform 0.6s var(--easing);
}
.stagger-children.visible > *:nth-child(1) { transition-delay: 0.0s; opacity: 1; transform: translateY(0); }
.stagger-children.visible > *:nth-child(2) { transition-delay: 0.1s; opacity: 1; transform: translateY(0); }
.stagger-children.visible > *:nth-child(3) { transition-delay: 0.2s; opacity: 1; transform: translateY(0); }
.stagger-children.visible > *:nth-child(4) { transition-delay: 0.3s; opacity: 1; transform: translateY(0); }
.stagger-children.visible > *:nth-child(5) { transition-delay: 0.4s; opacity: 1; transform: translateY(0); }
.stagger-children.visible > *:nth-child(6) { transition-delay: 0.5s; opacity: 1; transform: translateY(0); }
.stagger-children.visible > *:nth-child(7) { transition-delay: 0.6s; opacity: 1; transform: translateY(0); }

/* Dividers */
.section-divider {
  width: 100%;
  max-width: 200px;
  height: 1px;
  margin: 0 auto;
  background: linear-gradient(90deg, transparent, var(--cortex), transparent);
  opacity: 0.3;
}

/* ═══════════════════════════════════════════════════
   RESPONSIVE
   ═══════════════════════════════════════════════════ */
@media (max-width: 640px) {
  .container, .wide-container { padding: 0 20px; }
  section { padding: 60px 0; }
  .nav-links { display: none; }
  .components-grid { grid-template-columns: 1fr; }
}

/* Animated brain background for sections */
.brain-bg {
  position: absolute;
  right: -120px;
  top: 50%;
  transform: translateY(-50%);
  width: 500px;
  height: 500px;
  opacity: 0.03;
  pointer-events: none;
}

/* Citation tooltip */
.cite {
  cursor: help;
  border-bottom: 1px dotted var(--text-muted);
}

/* Special highlight block */
.highlight-block {
  background: linear-gradient(135deg, rgba(78,205,196,0.06), rgba(255,107,53,0.04));
  border-left: 3px solid var(--cortex);
  border-radius: 0 12px 12px 0;
  padding: 24px 28px;
  margin: 28px 0;
  font-size: 1rem;
  color: var(--text-secondary);
  line-height: 1.7;
}
.highlight-block strong {
  color: var(--text-primary);
}

/* Inline code */
code {
  font-family: var(--font-mono);
  font-size: 0.85em;
  background: var(--equation-bg);
  padding: 2px 8px;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

/* Floating particles */
.particles-container {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: -1;
  overflow: hidden;
}
.particle {
  position: absolute;
  width: 2px; height: 2px;
  background: var(--particle-color);
  border-radius: 50%;
  animation: float-particle linear infinite;
}
@keyframes float-particle {
  0% { transform: translateY(100vh) translateX(0); opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { transform: translateY(-10vh) translateX(40px); opacity: 0; }
}

/* Horizontal rule with brain motif */
.brain-hr {
  margin: 80px auto;
  text-align: center;
  position: relative;
}
.brain-hr::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0; right: 0;
  height: 1px;
  background: var(--border-color);
}
.brain-hr svg {
  position: relative;
  z-index: 1;
  background: var(--bg-primary);
  padding: 0 20px;
  transition: background var(--transition-speed);
}

/* ═══════════════════════════════════════════════════
   ANIMATED TOKEN FLOW CANVAS
   ═══════════════════════════════════════════════════ */
.token-flow-section {
  padding: 100px 0;
}
.canvas-outer {
  position: relative;
  width: 100%;
  margin-top: 40px;
  border-radius: 24px;
  overflow: hidden;
  border: 1px solid var(--border-accent);
  box-shadow: var(--shadow-card);
}
[data-theme="dark"] .canvas-outer {
  background: linear-gradient(145deg, #0d1a2a 0%, #0a1020 40%, #120a1e 70%, #0a0a14 100%);
}
[data-theme="light"] .canvas-outer {
  background: linear-gradient(145deg, #1a3a5c 0%, #15304e 40%, #2a1848 70%, #1a2040 100%);
}
#tokenFlowCanvas {
  width: 100%;
  height: 1340px;
  display: block;
}
.canvas-legend {
  position: absolute;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 18px;
  flex-wrap: wrap;
  justify-content: center;
}
.canvas-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.68rem;
  color: rgba(255,255,255,0.6);
  font-family: var(--font-mono);
  letter-spacing: 0.04em;
}
.canvas-legend-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.canvas-controls {
  position: absolute;
  top: 16px;
  right: 16px;
  display: flex;
  gap: 8px;
}
.canvas-controls button {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.15);
  color: rgba(255,255,255,0.7);
  font-family: var(--font-mono);
  font-size: 0.68rem;
  padding: 6px 14px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}
.canvas-controls button:hover {
  background: rgba(255,255,255,0.15);
  color: #fff;
}
.canvas-controls button.active {
  background: rgba(78,205,196,0.2);
  border-color: rgba(78,205,196,0.4);
  color: #4ecdc4;
}
</style>
</head>
<body>

<!-- Floating particles -->
<div class="particles-container" id="particles"></div>

<!-- Theme toggle -->
<button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
  <svg class="moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
  <svg class="sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
</button>

<!-- Navigation -->
<nav class="nav" id="nav">
  <span class="nav-logo">TRC²</span>
  <ul class="nav-links">
    <li><a href="#abstract">Abstract</a></li>
    <li><a href="#components">Architecture</a></li>
    <li><a href="#method">Method</a></li>
    <li><a href="#results">Results</a></li>
    <li><a href="#discussion">Discussion</a></li>
  </ul>
</nav>

<!-- ═══════════════════════════ HERO ═══════════════════════════ -->
<header class="hero">
  <canvas id="neural-canvas"></canvas>

  <div class="hero-badge">arXiv:2602.22479v1 · cs.LG · Feb 2026</div>

  <h1>
    <span class="accent">TRC²</span><br>
    Thalamically Routed<br>Cortical Columns
  </h1>

  <p class="hero-subtitle">
    Efficient Continual Learning in Language Models via<br>
    Biologically Grounded Sparse Routing & Fast Correction
  </p>

  <div class="hero-meta">
    <div class="hero-meta-item"><strong>Afshin Khadangi</strong> · SnT, University of Luxembourg</div>
    <div class="hero-meta-item">Working Paper · 169M params</div>
    <div class="hero-meta-item">~2.88B tokens trained</div>
  </div>

  <div class="hero-scroll-hint">
    <span>Scroll to explore</span>
    <div class="scroll-line"></div>
  </div>
</header>

<!-- ═══════════════════════════ ABSTRACT ═══════════════════════════ -->
<section id="abstract">
  <div class="container">
    <div class="reveal">
      <div class="section-label">Abstract</div>
      <div class="section-body">
        <p>Continual learning is a core requirement for deployed language models, yet standard training pipelines remain brittle under non-stationary data. Online updates often induce <em>catastrophic forgetting</em>, while stability-improving methods frequently increase latency and memory in ways that don't scale.</p>

        <p>We introduce <strong>TRC²</strong> (Thalamically Routed Cortical Columns), a decoder-only backbone that addresses continual learning <em>at the architectural level</em>. TRC² combines sparse thalamic routing over cortical columns with mechanisms for modulation, prediction, memory, and feedback — together with a fast corrective pathway that supports rapid adaptation without destabilizing slower parameters.</p>

        <p>The resulting block is sparse and chunk-parallel, enabling efficient training and inference while preserving clean ablations of each subsystem. Across language modeling and continual learning benchmarks, TRC² improves the stability–plasticity tradeoff at comparable compute.</p>
      </div>
    </div>

    <div class="highlight-block reveal" style="margin-top: 40px;">
      <strong>Core thesis:</strong> Continual learning should be an architectural property, not a bolt-on procedure. Plasticity should be localized in fast mechanisms while slower representational structures remain stable.
    </div>
  </div>
</section>

<div class="section-divider"></div>

<!-- ═══════════════════════════ CONTRIBUTIONS ═══════════════════════════ -->
<section>
  <div class="wide-container">
    <div class="reveal">
      <div class="section-label">Contributions</div>
      <div class="section-title">Three Key Contributions</div>
    </div>

    <div class="contrib-grid stagger-children reveal">
      <div class="contrib-card">
        <div class="contrib-num">01</div>
        <h3>The TRC² Architecture</h3>
        <p>A decoder-only backbone combining sparse thalamic top-k routing over cortical columns with biologically grounded mechanisms for modulation, prediction, memory, feedback, and fast correction.</p>
      </div>
      <div class="contrib-card">
        <div class="contrib-num">02</div>
        <h3>Sparse Chunk-Parallel Implementation</h3>
        <p>Topology-aware routing, chunk-level computation, and memory-aware execution with optional activation checkpointing for efficient training on modern accelerators.</p>
      </div>
      <div class="contrib-card">
        <div class="contrib-num">03</div>
        <h3>Continual Learning Evaluation Stack</h3>
        <p>Distributed multi-GPU training, standardized logging, and task-wise evaluations tracking forgetting and forward transfer under streaming domain shifts.</p>
      </div>
    </div>
  </div>
</section>

<div class="section-divider"></div>

<!-- ═══════════════════════════ BRAIN COMPONENTS ═══════════════════════════ -->
<section id="components">
  <div class="wide-container">
    <div class="reveal">
      <div class="section-label">Architecture</div>
      <div class="section-title">Seven Brain-Inspired Subsystems</div>
      <div class="section-body">
        <p>Each subsystem is independently toggleable and draws from a distinct neuroscience principle. Together they form a looped layer structure that routes, modulates, predicts, remembers, and corrects.</p>
      </div>
    </div>

    <div class="components-grid stagger-children reveal">

      <!-- Card 1: Neuromodulator -->
      <div class="comp-card" style="--card-accent: var(--neuromod);">
        <div class="comp-icon">
          <svg viewBox="0 0 72 72" class="icon-animated">
            <defs>
              <radialGradient id="glow-nm" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#f472b6" stop-opacity="0.3"/>
                <stop offset="100%" stop-color="#f472b6" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <circle cx="36" cy="36" r="34" fill="url(#glow-nm)"/>
            <!-- Central hub -->
            <circle cx="36" cy="36" r="8" fill="none" stroke="#f472b6" stroke-width="1.5" opacity="0.8"/>
            <circle cx="36" cy="36" r="3" fill="#f472b6" class="pulse"/>
            <!-- Three orbiting signals: D, ACh, NE -->
            <g style="transform-origin: 36px 36px; animation: rotate-slow 8s linear infinite;">
              <circle cx="36" cy="14" r="4" fill="#ff6b35" opacity="0.9"/>
              <text x="36" y="16" text-anchor="middle" fill="#0a0a0f" font-size="5" font-weight="bold" font-family="monospace">D</text>
            </g>
            <g style="transform-origin: 36px 36px; animation: rotate-slow 8s linear infinite reverse;">
              <circle cx="55" cy="48" r="4" fill="#4ecdc4" opacity="0.9"/>
              <text x="55" y="50" text-anchor="middle" fill="#0a0a0f" font-size="4.5" font-weight="bold" font-family="monospace">ACh</text>
            </g>
            <g style="transform-origin: 36px 36px; animation: rotate-slow 12s linear infinite;">
              <circle cx="17" cy="48" r="4" fill="#fbbf24" opacity="0.9"/>
              <text x="17" y="50" text-anchor="middle" fill="#0a0a0f" font-size="4.5" font-weight="bold" font-family="monospace">NE</text>
            </g>
            <!-- Connections -->
            <line x1="36" y1="28" x2="36" y2="18" stroke="#f472b6" stroke-width="0.7" class="synapse" opacity="0.5"/>
            <line x1="42" y1="40" x2="51" y2="46" stroke="#f472b6" stroke-width="0.7" class="synapse" opacity="0.5" style="animation-delay: 0.5s"/>
            <line x1="30" y1="40" x2="21" y2="46" stroke="#f472b6" stroke-width="0.7" class="synapse" opacity="0.5" style="animation-delay: 1s"/>
          </svg>
        </div>
        <h3>Neuromodulator Controller</h3>
        <p>Estimates dopamine, acetylcholine, and norepinephrine signals from running input statistics. Controls routing temperature, top-down/bottom-up balance, and global cortical gain.</p>
        <span class="comp-tag">Modulation</span>
      </div>

      <!-- Card 2: Predictive Cortex -->
      <div class="comp-card" style="--card-accent: var(--predictive);">
        <div class="comp-icon">
          <svg viewBox="0 0 72 72" class="icon-animated">
            <defs>
              <radialGradient id="glow-pc" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#fbbf24" stop-opacity="0.25"/>
                <stop offset="100%" stop-color="#fbbf24" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <circle cx="36" cy="36" r="34" fill="url(#glow-pc)"/>
            <!-- Prediction wave -->
            <path d="M12 36 Q 20 24, 28 36 T 44 36 T 60 36" fill="none" stroke="#fbbf24" stroke-width="1.5" stroke-dasharray="4 3" opacity="0.6">
              <animate attributeName="stroke-dashoffset" from="0" to="-28" dur="2s" repeatCount="indefinite"/>
            </path>
            <!-- Actual signal -->
            <path d="M12 38 Q 22 28, 30 38 T 48 38 T 60 38" fill="none" stroke="#ff6b35" stroke-width="1.2" opacity="0.8"/>
            <!-- Error arrows -->
            <line x1="28" y1="36" x2="30" y2="38" stroke="#ef4444" stroke-width="1" opacity="0.7">
              <animate attributeName="opacity" values="0.3;1;0.3" dur="1.5s" repeatCount="indefinite"/>
            </line>
            <line x1="44" y1="36" x2="48" y2="38" stroke="#ef4444" stroke-width="1" opacity="0.7">
              <animate attributeName="opacity" values="0.3;1;0.3" dur="1.5s" repeatCount="indefinite" begin="0.5s"/>
            </line>
            <!-- Labels -->
            <text x="12" y="52" fill="var(--text-muted)" font-size="5" font-family="monospace" opacity="0.7">P̂</text>
            <text x="50" y="52" fill="var(--text-muted)" font-size="5" font-family="monospace" opacity="0.7">ε = U − P̂</text>
          </svg>
        </div>
        <h3>Predictive Cortex</h3>
        <p>Implements Rao & Ballard predictive coding. A causal convolution generates prior predictions; the cortex processes prediction errors rather than raw signals. ACh dynamically weights the blend.</p>
        <span class="comp-tag">Prediction</span>
      </div>

      <!-- Card 3: Thalamic Router -->
      <div class="comp-card" style="--card-accent: var(--thalamus);">
        <div class="comp-icon">
          <svg viewBox="0 0 72 72" class="icon-animated">
            <defs>
              <radialGradient id="glow-th" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#ff6b35" stop-opacity="0.25"/>
                <stop offset="100%" stop-color="#ff6b35" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <circle cx="36" cy="36" r="34" fill="url(#glow-th)"/>
            <!-- Central thalamus -->
            <ellipse cx="36" cy="36" rx="10" ry="7" fill="none" stroke="#ff6b35" stroke-width="1.5" opacity="0.8"/>
            <circle cx="36" cy="36" r="3" fill="#ff6b35" opacity="0.8" class="pulse"/>
            <!-- Cortical columns (targets) -->
            <rect x="10" y="8" width="8" height="14" rx="2" fill="none" stroke="#4ecdc4" stroke-width="1" opacity="0.4"/>
            <rect x="24" y="6" width="8" height="14" rx="2" fill="none" stroke="#4ecdc4" stroke-width="1" opacity="0.8">
              <animate attributeName="opacity" values="0.4;1;0.4" dur="3s" repeatCount="indefinite"/>
            </rect>
            <rect x="40" y="6" width="8" height="14" rx="2" fill="none" stroke="#4ecdc4" stroke-width="1" opacity="0.8">
              <animate attributeName="opacity" values="0.4;1;0.4" dur="3s" repeatCount="indefinite" begin="0.5s"/>
            </rect>
            <rect x="54" y="8" width="8" height="14" rx="2" fill="none" stroke="#4ecdc4" stroke-width="1" opacity="0.4"/>
            <!-- Routing arrows (top-k selection) -->
            <line x1="32" y1="30" x2="28" y2="20" stroke="#ff6b35" stroke-width="1" class="synapse"/>
            <line x1="40" y1="30" x2="44" y2="20" stroke="#ff6b35" stroke-width="1" class="synapse" style="animation-delay: 0.4s"/>
            <!-- 2D topology grid hint -->
            <circle cx="18" cy="58" r="2" fill="#ff6b35" opacity="0.3"/>
            <circle cx="30" cy="58" r="2" fill="#ff6b35" opacity="0.3"/>
            <circle cx="42" cy="58" r="2" fill="#ff6b35" opacity="0.3"/>
            <circle cx="54" cy="58" r="2" fill="#ff6b35" opacity="0.3"/>
            <text x="36" y="66" text-anchor="middle" fill="var(--text-muted)" font-size="4.5" font-family="monospace" opacity="0.5">top-k</text>
          </svg>
        </div>
        <h3>Thalamic Router</h3>
        <p>Chunk-level sparse top-k routing with a topology-aware 2D prior. Encourages temporal continuity in column selection, reducing parameter interference during streaming updates.</p>
        <span class="comp-tag">Routing</span>
      </div>

      <!-- Card 4: Cortical Columns -->
      <div class="comp-card" style="--card-accent: var(--cortex);">
        <div class="comp-icon">
          <svg viewBox="0 0 72 72" class="icon-animated">
            <defs>
              <radialGradient id="glow-cx" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#4ecdc4" stop-opacity="0.25"/>
                <stop offset="100%" stop-color="#4ecdc4" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <circle cx="36" cy="36" r="34" fill="url(#glow-cx)"/>
            <!-- Three cortical columns -->
            <g>
              <rect x="12" y="12" width="12" height="48" rx="3" fill="none" stroke="#4ecdc4" stroke-width="1.2" opacity="0.8"/>
              <!-- Layers in column -->
              <line x1="12" y1="24" x2="24" y2="24" stroke="#4ecdc4" stroke-width="0.5" opacity="0.3"/>
              <line x1="12" y1="36" x2="24" y2="36" stroke="#4ecdc4" stroke-width="0.5" opacity="0.3"/>
              <line x1="12" y1="48" x2="24" y2="48" stroke="#4ecdc4" stroke-width="0.5" opacity="0.3"/>
              <!-- Active neurons -->
              <circle cx="18" cy="18" r="2" fill="#4ecdc4" class="pulse" style="animation-delay: 0s"/>
              <circle cx="18" cy="42" r="2" fill="#4ecdc4" class="pulse" style="animation-delay: 0.8s"/>
            </g>
            <g>
              <rect x="30" y="12" width="12" height="48" rx="3" fill="none" stroke="#4ecdc4" stroke-width="1.2" opacity="0.8"/>
              <line x1="30" y1="24" x2="42" y2="24" stroke="#4ecdc4" stroke-width="0.5" opacity="0.3"/>
              <line x1="30" y1="36" x2="42" y2="36" stroke="#4ecdc4" stroke-width="0.5" opacity="0.3"/>
              <line x1="30" y1="48" x2="42" y2="48" stroke="#4ecdc4" stroke-width="0.5" opacity="0.3"/>
              <circle cx="36" cy="30" r="2" fill="#4ecdc4" class="pulse" style="animation-delay: 0.4s"/>
              <circle cx="36" cy="54" r="2" fill="#34d399" class="pulse" style="animation-delay: 1.2s"/>
            </g>
            <g>
              <rect x="48" y="12" width="12" height="48" rx="3" fill="none" stroke="#4ecdc4" stroke-width="1.2" opacity="0.8"/>
              <line x1="48" y1="24" x2="60" y2="24" stroke="#4ecdc4" stroke-width="0.5" opacity="0.3"/>
              <line x1="48" y1="36" x2="60" y2="36" stroke="#4ecdc4" stroke-width="0.5" opacity="0.3"/>
              <line x1="48" y1="48" x2="60" y2="48" stroke="#4ecdc4" stroke-width="0.5" opacity="0.3"/>
              <circle cx="54" cy="18" r="2" fill="#4ecdc4" class="pulse" style="animation-delay: 0.6s"/>
            </g>
            <!-- E/I labels -->
            <text x="18" y="33" text-anchor="middle" fill="#34d399" font-size="4" font-weight="bold" font-family="monospace">E</text>
            <text x="36" y="21" text-anchor="middle" fill="#ef4444" font-size="4" font-weight="bold" font-family="monospace">I</text>
          </svg>
        </div>
        <h3>Cortical Columns</h3>
        <p>Compact microcircuits with selective state-space updates, excitatory/inhibitory gating (SST·PV·VIP interneurons), adaptive membrane filtering, and causal within-chunk processing.</p>
        <span class="comp-tag">Computation</span>
      </div>

      <!-- Card 5: Hippocampal Memory -->
      <div class="comp-card" style="--card-accent: var(--hippocampus);">
        <div class="comp-icon">
          <svg viewBox="0 0 72 72" class="icon-animated">
            <defs>
              <radialGradient id="glow-hp" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#a78bfa" stop-opacity="0.25"/>
                <stop offset="100%" stop-color="#a78bfa" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <circle cx="36" cy="36" r="34" fill="url(#glow-hp)"/>
            <!-- Hippocampal shape -->
            <path d="M20 38 C20 26, 36 20, 52 28 C58 32, 56 42, 48 44 C42 46, 34 44, 28 46 C22 48, 18 44, 20 38Z" fill="none" stroke="#a78bfa" stroke-width="1.5" opacity="0.7"/>
            <!-- Memory slots (engrams) -->
            <circle cx="30" cy="32" r="3" fill="#a78bfa" opacity="0.6" class="pulse"/>
            <circle cx="42" cy="30" r="3" fill="#a78bfa" opacity="0.6" class="pulse" style="animation-delay: 0.5s"/>
            <circle cx="48" cy="38" r="3" fill="#a78bfa" opacity="0.6" class="pulse" style="animation-delay: 1s"/>
            <circle cx="36" cy="40" r="3" fill="#a78bfa" opacity="0.6" class="pulse" style="animation-delay: 1.5s"/>
            <!-- Retrieval beams -->
            <line x1="30" y1="32" x2="42" y2="30" stroke="#a78bfa" stroke-width="0.6" class="synapse" opacity="0.4"/>
            <line x1="42" y1="30" x2="48" y2="38" stroke="#a78bfa" stroke-width="0.6" class="synapse" opacity="0.4" style="animation-delay: 0.3s"/>
            <line x1="48" y1="38" x2="36" y2="40" stroke="#a78bfa" stroke-width="0.6" class="synapse" opacity="0.4" style="animation-delay: 0.6s"/>
            <!-- Label -->
            <text x="36" y="58" text-anchor="middle" fill="var(--text-muted)" font-size="4.5" font-family="monospace" opacity="0.5">Hopfield Net</text>
          </svg>
        </div>
        <h3>Associative Memory</h3>
        <p>Modern Hopfield Network with learned engram patterns. Chunk-level queries retrieve content-addressable long-range context, providing unlimited-range binding beyond lateral convolutions.</p>
        <span class="comp-tag">Memory</span>
      </div>

      <!-- Card 6: Dendritic Readout -->
      <div class="comp-card" style="--card-accent: var(--dendrite);">
        <div class="comp-icon">
          <svg viewBox="0 0 72 72" class="icon-animated">
            <defs>
              <radialGradient id="glow-dn" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#34d399" stop-opacity="0.25"/>
                <stop offset="100%" stop-color="#34d399" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <circle cx="36" cy="36" r="34" fill="url(#glow-dn)"/>
            <!-- Neuron body -->
            <ellipse cx="36" cy="40" rx="8" ry="6" fill="none" stroke="#34d399" stroke-width="1.5" opacity="0.8"/>
            <!-- Apical dendrite (top-down) -->
            <line x1="36" y1="34" x2="36" y2="14" stroke="#a78bfa" stroke-width="1.2" opacity="0.7"/>
            <line x1="36" y1="14" x2="28" y2="8" stroke="#a78bfa" stroke-width="0.8" opacity="0.5"/>
            <line x1="36" y1="14" x2="44" y2="8" stroke="#a78bfa" stroke-width="0.8" opacity="0.5"/>
            <text x="50" y="12" fill="#a78bfa" font-size="4.5" font-family="monospace" opacity="0.6">apical</text>
            <!-- Basal dendrite (bottom-up) -->
            <line x1="30" y1="44" x2="18" y2="52" stroke="#4ecdc4" stroke-width="1.2" opacity="0.7"/>
            <line x1="42" y1="44" x2="54" y2="52" stroke="#4ecdc4" stroke-width="1.2" opacity="0.7"/>
            <line x1="18" y1="52" x2="12" y2="58" stroke="#4ecdc4" stroke-width="0.8" opacity="0.5"/>
            <line x1="54" y1="52" x2="60" y2="58" stroke="#4ecdc4" stroke-width="0.8" opacity="0.5"/>
            <text x="8" y="66" fill="#4ecdc4" font-size="4.5" font-family="monospace" opacity="0.6">basal</text>
            <!-- Plateau potential indicator -->
            <circle cx="36" cy="24" r="3" fill="#34d399" opacity="0.5">
              <animate attributeName="r" values="2;4;2" dur="2s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.3;0.8;0.3" dur="2s" repeatCount="indefinite"/>
            </circle>
            <!-- Axon -->
            <line x1="36" y1="46" x2="36" y2="60" stroke="#34d399" stroke-width="1" opacity="0.6"/>
            <polygon points="33,60 36,66 39,60" fill="#34d399" opacity="0.6"/>
          </svg>
        </div>
        <h3>Dendritic Readout</h3>
        <p>Two-compartment neuron model: basal compartment receives bottom-up cortical drive while apical receives top-down hippocampal context. A sigmoid plateau potential gates interaction — matching Larkum et al. 1999.</p>
        <span class="comp-tag">Feedback</span>
      </div>

      <!-- Card 7: Cerebellar Corrector -->
      <div class="comp-card" style="--card-accent: var(--cerebellum);">
        <div class="comp-icon">
          <svg viewBox="0 0 72 72" class="icon-animated">
            <defs>
              <radialGradient id="glow-cb" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="#45b7d1" stop-opacity="0.25"/>
                <stop offset="100%" stop-color="#45b7d1" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <circle cx="36" cy="36" r="34" fill="url(#glow-cb)"/>
            <!-- Cerebellum folia pattern -->
            <path d="M16 36 Q 22 28, 28 36 Q 34 44, 36 36 Q 38 28, 44 36 Q 50 44, 56 36" fill="none" stroke="#45b7d1" stroke-width="1.5" opacity="0.7"/>
            <path d="M18 42 Q 24 36, 30 42 Q 36 48, 42 42 Q 48 36, 54 42" fill="none" stroke="#45b7d1" stroke-width="1" opacity="0.4"/>
            <!-- Fast weight arrows -->
            <path d="M20 20 L 52 20" fill="none" stroke="#ff6b35" stroke-width="1" stroke-dasharray="3 2" opacity="0.6">
              <animate attributeName="stroke-dashoffset" from="0" to="-20" dur="1s" repeatCount="indefinite"/>
            </path>
            <text x="36" y="18" text-anchor="middle" fill="#ff6b35" font-size="4" font-family="monospace" opacity="0.6">fast Δ</text>
            <!-- Low rank indicator -->
            <text x="36" y="58" text-anchor="middle" fill="var(--text-muted)" font-size="4.5" font-family="monospace" opacity="0.5">rank-r</text>
            <!-- U and V matrices -->
            <rect x="14" y="50" width="10" height="6" rx="1" fill="none" stroke="#45b7d1" stroke-width="0.8" opacity="0.5"/>
            <text x="19" y="55" text-anchor="middle" fill="#45b7d1" font-size="4" font-family="monospace" opacity="0.6">V</text>
            <rect x="48" y="50" width="10" height="6" rx="1" fill="none" stroke="#45b7d1" stroke-width="0.8" opacity="0.5"/>
            <text x="53" y="55" text-anchor="middle" fill="#45b7d1" font-size="4" font-family="monospace" opacity="0.6">U</text>
          </svg>
        </div>
        <h3>Cerebellar Corrector</h3>
        <p>Low-rank fast-weight corrective pathway. Computes rank-r residuals from both the normalized input and cortex output, enabling rapid online adjustment without rewriting slow cortical parameters.</p>
        <span class="comp-tag">Correction</span>
      </div>

    </div>
  </div>
</section>

<div class="section-divider"></div>

<!-- ═══════════════════════════ ARCHITECTURE FLOW ═══════════════════════════ -->
<section id="method" class="arch-section">
  <div class="container">
    <div class="reveal">
      <div class="section-label">Data Flow</div>
      <div class="section-title">The TRC² Block: Signal Flow</div>
      <div class="section-body" style="margin-bottom: 40px;">
        <p>Each TRC² layer follows a structured forward pass: normalize, modulate, predict, route, compute in parallel columns, refine routing, correct, and merge via residual connections.</p>
      </div>
    </div>

    <div class="arch-flow reveal">
      <div class="arch-node" style="--node-color: #fbbf24;">
        <div class="arch-node-label"><span class="dot" style="background:#fbbf24;"></span>Input</div>
        <div class="arch-node-title">X ∈ ℝ<sup>B×T×d</sup></div>
        <div class="arch-node-desc">Token + positional embeddings → RMSNorm</div>
      </div>

      <div class="arch-arrow"></div>

      <div class="arch-node" style="--node-color: #f472b6;">
        <div class="arch-node-label"><span class="dot" style="background:#f472b6;"></span>① Neuromodulator</div>
        <div class="arch-node-title">ModCtrl(U) → s<sub>route</sub>, s<sub>pred</sub>, s<sub>gain</sub></div>
        <div class="arch-node-desc">EMA deviation stats → 2-layer MLP → 3 control signals ∈ [0,1]</div>
      </div>

      <div class="arch-arrow"></div>

      <div class="arch-node" style="--node-color: #fbbf24;">
        <div class="arch-node-label"><span class="dot" style="background:#fbbf24;"></span>② Predictive Coding</div>
        <div class="arch-node-title">Û = U − (1 − s<sub>pred</sub>)·P̃</div>
        <div class="arch-node-desc">Causal conv prediction → error blend → aux ℒ<sub>pred</sub></div>
      </div>

      <div class="arch-arrow"></div>

      <div class="arch-node" style="--node-color: #ff6b35;">
        <div class="arch-node-label"><span class="dot" style="background:#ff6b35;"></span>③ Thalamic Router</div>
        <div class="arch-node-title">I, R, S = TopK(L, k)</div>
        <div class="arch-node-desc">Chunk-pool → Q·K<sup>T</sup> + topology prior → top-k softmax</div>
      </div>

      <div class="arch-arrow"></div>

      <div class="arch-node" style="--node-color: #a78bfa;">
        <div class="arch-node-label"><span class="dot" style="background:#a78bfa;"></span>④ Associative Memory</div>
        <div class="arch-node-title">C<sup>mem</sup> = HopfieldRetrieve(Ū, Ξ)</div>
        <div class="arch-node-desc">Chunk queries → normalized Hopfield → content-addressable context</div>
      </div>

      <div class="arch-arrow"></div>

      <div class="arch-node" style="--node-color: #4ecdc4; border-width: 2px;">
        <div class="arch-node-label"><span class="dot" style="background:#4ecdc4;"></span>⑤ Parallel Cortex</div>
        <div class="arch-node-title">Y = Cortex(Û, I, R, C<sup>mem</sup>)</div>
        <div class="arch-node-desc">Dense projection → E/I gating → adaptive membrane → causal conv → dendritic readout → routed mixture</div>
      </div>

      <div class="arch-arrow"></div>

      <div class="arch-node" style="--node-color: #fb923c;">
        <div class="arch-node-label"><span class="dot" style="background:#fb923c;"></span>⑥ Routing Refinement</div>
        <div class="arch-node-title">R′ = softmax(S + α<sub>fb</sub>·S<sup>fb</sup>)</div>
        <div class="arch-node-desc">Cortex output → feedback projection → refine weights → 2nd cortex pass</div>
      </div>

      <div class="arch-arrow"></div>

      <div class="arch-node" style="--node-color: #45b7d1;">
        <div class="arch-node-label"><span class="dot" style="background:#45b7d1;"></span>⑦ Cerebellar Correction</div>
        <div class="arch-node-title">Δ = SiLU(Z)·V·U<sup>T</sup></div>
        <div class="arch-node-desc">Low-rank fast-weight residual from [Û; Y] → rank-r correction</div>
      </div>

      <div class="arch-arrow"></div>

      <div class="arch-node" style="--node-color: #34d399;">
        <div class="arch-node-label"><span class="dot" style="background:#34d399;"></span>Output</div>
        <div class="arch-node-title">X<sup>+</sup> = X + Drop(g<sub>gain</sub>⊙Y + Δ)</div>
        <div class="arch-node-desc">Global gain modulation → residual + dropout → RMSNorm → SwiGLU FFN → residual</div>
      </div>
    </div>

    <!-- Key equations -->
    <div class="reveal" style="margin-top: 56px;">
      <div class="section-label">Key Equations</div>

      <div class="equation-block" data-eq="(3-5)">
        U = RMSNorm(X),&nbsp;&nbsp;&nbsp;(s_route, s_pred, s_gain) = ModCtrl(U),&nbsp;&nbsp;&nbsp;Û = U − (1−s_pred)·P̃
      </div>

      <div class="equation-block" data-eq="(6-8)">
        (I, R, S, ℒ_route) = Router(Û),&nbsp;&nbsp;&nbsp;C^mem = AssocMem(Ū),&nbsp;&nbsp;&nbsp;Y = Cortex(Û, I, R, C^mem)
      </div>

      <div class="equation-block" data-eq="(13-14)">
        X̃ = X + Drop(g_gain⊙Y + Δ),&nbsp;&nbsp;&nbsp;X⁺ = X̃ + Drop(SwiGLU(RMSNorm(X̃)))
      </div>

      <div class="equation-block" data-eq="(53)">
        ℒ_train = ℒ_CE + 0.1·ℒ^Σ_pred + ℒ^Σ_route
      </div>
    </div>
  </div>
</section>

<div class="section-divider"></div>

<!-- ═══════════════════════════ ANIMATED TOKEN FLOW ═══════════════════════════ -->
<section class="token-flow-section">
  <div class="wide-container">
    <div class="reveal">
      <div class="section-label">Live Visualization</div>
      <div class="section-title">Animated Token Flow Through TRC² Block</div>
      <div class="section-body">
        <p>Watch token particles flow through the complete TRC² block — from input normalization through thalamic routing, into active cortical columns with E/I gating, past the Hopfield associative memory, through dendritic readout and cortico-thalamic feedback, and finally the cerebellar fast-weight corrector merging into the residual stream.</p>
      </div>
    </div>

    <div class="canvas-outer reveal">
      <canvas id="tokenFlowCanvas"></canvas>
      <div class="canvas-controls">
        <button id="btnSpeed" class="active" onclick="toggleSpeed()">1× Speed</button>
        <button id="btnLabels" class="active" onclick="toggleLabels()">Labels</button>
      </div>
      <div class="canvas-legend">
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:#f472b6"></div>① Neuromod</div>
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:#60a5fa"></div>② Pred Cortex</div>
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:#fb923c"></div>③ Router</div>
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:#4ecdc4"></div>④ Cortex</div>
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:#a78bfa"></div>⑤ Hopfield</div>
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:#c4b5fd"></div>⑥ Dendritic</div>
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:#fbbf24"></div>⑦ CT Feedback</div>
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:#22d3ee"></div>⑧ Cerebellum</div>
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:#f87171"></div>⑨ NE Gain</div>
        <div class="canvas-legend-item"><div class="canvas-legend-dot" style="background:rgba(255,255,255,0.5)"></div>Token Flow</div>
      </div>
    </div>
  </div>
</section>

<div class="section-divider"></div>

<!-- ═══════════════════════════ RESULTS ═══════════════════════════ -->
<section id="results">
  <div class="wide-container">
    <div class="reveal">
      <div class="section-label">Experiments</div>
      <div class="section-title">Results</div>
      <div class="section-body">
        <p>Evaluated on C4, WikiText-103, and LAMBADA with 4×V100 GPUs, 2.88B tokens, against parameter-matched Transformer and Mamba baselines. TRC² achieves dramatically lower perplexity and higher BLEU, with substantially reduced continual-learning forgetting.</p>
      </div>
    </div>

    <!-- Table 1 -->
    <div class="reveal" style="margin-top: 40px;">
      <h3 style="font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 16px;">Table 1 — Evaluation Performance & Efficiency</h3>
      <div class="results-table-wrap">
        <table class="results-table">
          <thead>
            <tr>
              <th>Model</th>
              <th>Params</th>
              <th>d<sub>m</sub></th>
              <th>PPL C4 ↓</th>
              <th>PPL Wiki ↓</th>
              <th>PPL LAM ↓</th>
              <th>BLEU C4 ↑</th>
              <th>BLEU Wiki ↑</th>
              <th>BLEU LAM ↑</th>
              <th>Tok/s ↑</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Transformer</td>
              <td>162M</td>
              <td>768</td>
              <td>60.70</td>
              <td>215.18</td>
              <td>105.72</td>
              <td>8.12</td>
              <td>8.23</td>
              <td>5.09</td>
              <td>~127k</td>
            </tr>
            <tr>
              <td>Mamba</td>
              <td>176M</td>
              <td>768</td>
              <td>70.45</td>
              <td>357.67</td>
              <td>116.73</td>
              <td>6.90</td>
              <td>2.87</td>
              <td>3.97</td>
              <td>~108k</td>
            </tr>
            <tr class="highlight-row">
              <td><strong>TRC² (ours)</strong></td>
              <td>169M</td>
              <td>512</td>
              <td class="best-val">2.00</td>
              <td class="best-val">2.56</td>
              <td class="best-val">2.02</td>
              <td class="best-val">71.66</td>
              <td class="best-val">66.57</td>
              <td class="best-val">70.07</td>
              <td>~57k</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Perplexity Chart -->
    <div class="chart-container reveal">
      <div class="chart-title">Perplexity Comparison — C4 (lower is better)</div>
      <div class="chart-bars" id="ppl-chart">
        <div class="chart-bar-row">
          <div class="chart-bar-label">Transformer</div>
          <div class="chart-bar-track">
            <div class="chart-bar-fill transformer" style="width: 0%;" data-target="86" data-val="60.70"></div>
          </div>
        </div>
        <div class="chart-bar-row">
          <div class="chart-bar-label">Mamba</div>
          <div class="chart-bar-track">
            <div class="chart-bar-fill mamba" style="width: 0%;" data-target="100" data-val="70.45"></div>
          </div>
        </div>
        <div class="chart-bar-row">
          <div class="chart-bar-label">TRC² (ours)</div>
          <div class="chart-bar-track">
            <div class="chart-bar-fill trc2" style="width: 0%;" data-target="2.8" data-val="2.00"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- BLEU Chart -->
    <div class="chart-container reveal">
      <div class="chart-title">BLEU Score — C4 (higher is better)</div>
      <div class="chart-bars" id="bleu-chart">
        <div class="chart-bar-row">
          <div class="chart-bar-label">Transformer</div>
          <div class="chart-bar-track">
            <div class="chart-bar-fill transformer" style="width: 0%;" data-target="11.3" data-val="8.12"></div>
          </div>
        </div>
        <div class="chart-bar-row">
          <div class="chart-bar-label">Mamba</div>
          <div class="chart-bar-track">
            <div class="chart-bar-fill mamba" style="width: 0%;" data-target="9.6" data-val="6.90"></div>
          </div>
        </div>
        <div class="chart-bar-row">
          <div class="chart-bar-label">TRC² (ours)</div>
          <div class="chart-bar-track">
            <div class="chart-bar-fill trc2" style="width: 0%;" data-target="100" data-val="71.66"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table 2 -->
    <div class="reveal" style="margin-top: 40px;">
      <h3 style="font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 16px;">Table 2 — Continual Learning: Average Forgetting</h3>
      <div class="results-table-wrap">
        <table class="results-table">
          <thead>
            <tr>
              <th>Model</th>
              <th colspan="3" style="text-align:center;">Last Step ↓</th>
              <th colspan="3" style="text-align:center;">Normalized AUC ↓</th>
            </tr>
            <tr>
              <th></th>
              <th>PPL</th>
              <th>TokAcc</th>
              <th>BLEU</th>
              <th>PPL</th>
              <th>TokAcc</th>
              <th>BLEU</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Transformer</td>
              <td class="best-val">0.0000</td>
              <td>0.0014</td>
              <td>0.3757</td>
              <td>0.0669</td>
              <td>0.0008</td>
              <td>0.1684</td>
            </tr>
            <tr>
              <td>Mamba</td>
              <td class="best-val">0.0000</td>
              <td class="best-val">0.0006</td>
              <td>0.0900</td>
              <td>0.3371</td>
              <td>0.0011</td>
              <td>0.1957</td>
            </tr>
            <tr class="highlight-row">
              <td><strong>TRC² (ours)</strong></td>
              <td>0.0110</td>
              <td>0.0010</td>
              <td class="best-val">0.0435</td>
              <td class="best-val">0.0018</td>
              <td class="best-val">0.0008</td>
              <td class="best-val">0.0981</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="highlight-block reveal" style="margin-top: 32px;">
      <strong>Key insight:</strong> TRC² shows 37× lower normalized PPL forgetting AUC than Transformer and 187× lower than Mamba — the model retains earlier behavior consistently over the full stream, not just at the final step.
    </div>
  </div>
</section>

<div class="section-divider"></div>

<!-- ═══════════════════════════ DISCUSSION ═══════════════════════════ -->
<section id="discussion">
  <div class="container">
    <div class="reveal">
      <div class="section-label">Discussion & Conclusion</div>
      <div class="section-title">Making Interference Control Part of the Forward Pass</div>
      <div class="section-body">
        <p>The results support TRC²'s core design claim: continual learning improves when plasticity is allocated to a small, explicit pathway while keeping most representational structure stable. The normalized forgetting AUC — tracking behavior over the <em>full</em> training stream — shows markedly lower forgetting than both baselines.</p>

        <p>TRC² trades raw throughput for structured sparsity and online-correctable computation. The chunked routing scheme amortizes router overhead, but end-to-end performance remains sensitive to kernel fusion and memory layout. The favorable scaling regime appears when routing decisions are stable across neighboring tokens and column-local scans stay contiguous in memory.</p>

        <p>Several mechanisms likely contribute: topology-aware routing encourages temporal continuity, reducing parameter interference. Excitatory-inhibitory gating suppresses unstable activations before residual propagation. The cerebellar corrector provides fast stream-driven adjustment without rewriting slower parameters.</p>

        <p>Future work should extend evaluation to larger scales and longer contexts, study router stability under harder non-stationary streams, and couple the corrective pathway with deployment-time constraints for bounded, interpretable, and reversible adaptation.</p>
      </div>
    </div>
  </div>
</section>

<!-- ═══════════════════════════ FOOTER ═══════════════════════════ -->
<footer class="footer">
  <div class="container">
    <p>TRC² — Thalamically Routed Cortical Columns · Afshin Khadangi · SnT, University of Luxembourg</p>
    <p style="margin-top: 8px;">arXiv:2602.22479v1 [cs.LG] · February 2026 · Working Paper</p>
  </div>
</footer>

<!-- ═══════════════════════════ SCRIPTS ═══════════════════════════ -->
<script>
// ── Theme Toggle ──
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  html.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
}

// ── Navigation show on scroll ──
const nav = document.getElementById('nav');
let lastScroll = 0;
window.addEventListener('scroll', () => {
  const y = window.scrollY;
  if (y > 400) nav.classList.add('visible');
  else nav.classList.remove('visible');
  lastScroll = y;
});

// ── Scroll reveal ──
const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -60px 0px' };
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.classList.add('visible');
      // Animate chart bars
      if (entry.target.querySelector('.chart-bar-fill')) {
        entry.target.querySelectorAll('.chart-bar-fill').forEach(bar => {
          bar.style.width = bar.dataset.target + '%';
        });
      }
    }
  });
}, observerOptions);
document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

// ── Neural Network Canvas ──
const canvas = document.getElementById('neural-canvas');
const ctx = canvas.getContext('2d');
let nodes = [];
let animId;

function resizeCanvas() {
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
}

function initNodes() {
  nodes = [];
  const count = Math.min(80, Math.floor(canvas.width * canvas.height / 12000));
  for (let i = 0; i < count; i++) {
    nodes.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.4,
      vy: (Math.random() - 0.5) * 0.4,
      r: Math.random() * 2 + 1,
      pulse: Math.random() * Math.PI * 2
    });
  }
}

function drawNeural() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const time = Date.now() * 0.001;
  const theme = document.documentElement.getAttribute('data-theme');
  const lineColor = theme === 'dark' ? 'rgba(78,205,196,' : 'rgba(78,205,196,';
  const nodeColor = theme === 'dark' ? 'rgba(78,205,196,' : 'rgba(78,205,196,';

  // Update positions
  nodes.forEach(n => {
    n.x += n.vx;
    n.y += n.vy;
    if (n.x < 0 || n.x > canvas.width) n.vx *= -1;
    if (n.y < 0 || n.y > canvas.height) n.vy *= -1;
    n.pulse += 0.02;
  });

  // Draw connections
  for (let i = 0; i < nodes.length; i++) {
    for (let j = i + 1; j < nodes.length; j++) {
      const dx = nodes[i].x - nodes[j].x;
      const dy = nodes[i].y - nodes[j].y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 150) {
        const alpha = (1 - dist / 150) * 0.15;
        ctx.beginPath();
        ctx.moveTo(nodes[i].x, nodes[i].y);
        ctx.lineTo(nodes[j].x, nodes[j].y);
        ctx.strokeStyle = lineColor + alpha + ')';
        ctx.lineWidth = 0.5;
        ctx.stroke();
      }
    }
  }

  // Draw nodes
  nodes.forEach(n => {
    const pulseR = n.r + Math.sin(n.pulse) * 0.5;
    const alpha = 0.4 + Math.sin(n.pulse) * 0.2;
    ctx.beginPath();
    ctx.arc(n.x, n.y, pulseR, 0, Math.PI * 2);
    ctx.fillStyle = nodeColor + alpha + ')';
    ctx.fill();
  });

  animId = requestAnimationFrame(drawNeural);
}

resizeCanvas();
initNodes();
drawNeural();
window.addEventListener('resize', () => { resizeCanvas(); initNodes(); });

// ── Floating particles ──
const particlesContainer = document.getElementById('particles');
function createParticle() {
  const p = document.createElement('div');
  p.className = 'particle';
  p.style.left = Math.random() * 100 + '%';
  p.style.animationDuration = (15 + Math.random() * 25) + 's';
  p.style.animationDelay = Math.random() * 10 + 's';
  p.style.width = p.style.height = (1 + Math.random() * 2) + 'px';
  particlesContainer.appendChild(p);
}
for (let i = 0; i < 30; i++) createParticle();

// ── Smooth scroll for nav links ──
document.querySelectorAll('.nav-links a').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    const target = document.querySelector(a.getAttribute('href'));
    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
});

// ═══════════════════════════════════════════════════
// ───── ANIMATED TOKEN FLOW CANVAS ─────
// ═══════════════════════════════════════════════════
(function() {
  const canvas = document.getElementById('tokenFlowCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let W, H, dpr;
  let showLabels = true;
  let speedMult = 1;

  const NCOLS = 8, ACTIVE = [1, 3, 6];

  function resize() {
    dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    W = rect.width; H = rect.height;
    canvas.width = W * dpr; canvas.height = H * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  resize(); window.addEventListener('resize', resize);

  /* ── Color palette ── */
  const CL = {
    input:  {f:'rgba(253,224,71,0.10)',s:'rgba(253,224,71,0.45)',t:'rgba(253,224,71,0.85)'},
    norm:   {f:'rgba(148,163,184,0.10)',s:'rgba(148,163,184,0.40)',t:'rgba(148,163,184,0.75)'},
    neuro:  {f:'rgba(244,114,182,0.10)',s:'rgba(244,114,182,0.45)',t:'rgba(244,114,182,0.85)'},
    pred:   {f:'rgba(96,165,250,0.10)', s:'rgba(96,165,250,0.40)', t:'rgba(96,165,250,0.80)'},
    pad:    {f:'rgba(134,239,172,0.08)',s:'rgba(134,239,172,0.35)',t:'rgba(134,239,172,0.70)'},
    router: {f:'rgba(251,146,60,0.12)', s:'rgba(251,146,60,0.50)', t:'rgba(251,146,60,0.90)'},
    cortex: {f:'rgba(78,205,196,0.06)', s:'rgba(78,205,196,0.38)', t:'rgba(78,205,196,0.80)'},
    cxSub:  {f:'rgba(78,205,196,0.04)', s:'rgba(78,205,196,0.22)', t:'rgba(78,205,196,0.60)'},
    hopf:   {f:'rgba(167,139,250,0.08)',s:'rgba(167,139,250,0.40)',t:'rgba(167,139,250,0.80)'},
    dend:   {f:'rgba(196,181,253,0.08)',s:'rgba(196,181,253,0.40)',t:'rgba(196,181,253,0.78)'},
    dSub:   {f:'rgba(196,181,253,0.04)',s:'rgba(196,181,253,0.22)',t:'rgba(196,181,253,0.58)'},
    ctfb:   {f:'rgba(251,191,36,0.10)', s:'rgba(251,191,36,0.45)', t:'rgba(251,191,36,0.85)'},
    ctpass: {f:'rgba(251,191,36,0.06)', s:'rgba(251,191,36,0.28)', t:'rgba(251,191,36,0.62)'},
    cereb:  {f:'rgba(34,211,238,0.10)', s:'rgba(34,211,238,0.45)', t:'rgba(34,211,238,0.85)'},
    negain: {f:'rgba(248,113,113,0.12)',s:'rgba(248,113,113,0.50)',t:'rgba(248,113,113,0.88)'},
    resid:  {f:'rgba(148,163,184,0.06)',s:'rgba(148,163,184,0.22)',t:'rgba(148,163,184,0.52)'},
    ffn:    {f:'rgba(96,165,250,0.08)', s:'rgba(96,165,250,0.28)', t:'rgba(96,165,250,0.62)'},
    w:'rgba(255,255,255,',
  };

  function layout() {
    const bx=100, bw=W-270, bh=26, bh2=22;
    const mx=bx+bw/2, br=bx+bw;
    return {
      bx,bw,bh,bh2,mx,br,
      hx:br+16, hw:Math.min(140,W-br-22),
      input:28, norm:60, neuro:110, sigs:144,
      pred:190, pad:240, router:292,
      // Cortex container (expanded for columns)
      cxTop:352, cxP1:376, cxP2:404, cxP3:432, cxP4:460,
      colTop:486, colBot:588, cxBot:610,
      // Dendritic
      dTop:644, dN:668, dL:700, dBot:728,
      yLbl:754,
      ct:794, ct2:842,
      cereb:902,
      plus:956,
      neGain:996,
      res1:1044, norm2:1086, ffn:1126, res2:1170,
      output:1214,
      skipX:86, uPathX:74, fbLoopX:bx-22,
    };
  }

  /* ── Drawing helpers ── */
  function rr(x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}
  function bar(x,y,w,h,c,text,sz){rr(x,y,w,h,5);ctx.fillStyle=c.f;ctx.fill();ctx.strokeStyle=c.s;ctx.lineWidth=1;ctx.stroke();if(showLabels&&text){ctx.font=`600 ${sz||8}px "DM Mono","JetBrains Mono",monospace`;ctx.fillStyle=c.t;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(text,x+w/2,y+h/2);}}
  function lbl(x,y,text,color,align,sz){if(!showLabels)return;ctx.font=`500 ${sz||7.5}px "DM Mono","JetBrains Mono",monospace`;ctx.fillStyle=color||CL.w+'0.4)';ctx.textAlign=align||'center';ctx.textBaseline='middle';ctx.fillText(text,x,y);}
  function cn(x1,y1,x2,y2,c,w,d){ctx.beginPath();if(d)ctx.setLineDash(d);ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.strokeStyle=c;ctx.lineWidth=w||0.8;ctx.stroke();if(d)ctx.setLineDash([]);}
  function arr(x,y,dir,sz,c){ctx.beginPath();if(dir==='d'){ctx.moveTo(x-sz,y-sz);ctx.lineTo(x,y);ctx.lineTo(x+sz,y-sz);}else if(dir==='r'){ctx.moveTo(x-sz,y-sz);ctx.lineTo(x,y);ctx.lineTo(x-sz,y+sz);}else if(dir==='l'){ctx.moveTo(x+sz,y-sz);ctx.lineTo(x,y);ctx.lineTo(x+sz,y+sz);}else{ctx.moveTo(x-sz,y+sz);ctx.lineTo(x,y);ctx.lineTo(x+sz,y+sz);}ctx.fillStyle=c;ctx.fill();}
  function lerp(a,b,t){return a+(b-a)*t;}
  function colX(i,L){return L.bx+20+i*((L.bw-40)/(NCOLS-1));}

  /* ── Particle classes ── */
  class MainP{
    constructor(){this.reset();}
    reset(){this.ph=0;this.t=Math.random();this.sp=0.0025+Math.random()*0.003;this.sz=1.5+Math.random()*1.2;this.a=1;this.col=ACTIVE[Math.floor(Math.random()*3)];this.hue=Math.random()>0.5?'78,205,196':'253,224,71';}
    update(){this.t+=this.sp*speedMult;if(this.t>=1){this.t=0;this.ph++;if(this.ph>10)this.reset();}}
    pos(L){
      const m=L.mx,t=this.t,cx=colX(this.col,L);
      switch(this.ph){
        case 0:return{x:m,y:lerp(L.input,L.router+L.bh/2,t)};
        case 1:{const s=Math.min(1,t*2);return{x:lerp(m,cx,s*0.8),y:lerp(L.router+L.bh/2,L.colTop,t)};}
        case 2:return{x:cx+Math.sin(t*Math.PI*5)*5,y:lerp(L.colTop,L.colBot,t)};
        case 3:return{x:lerp(cx,m,t*0.6),y:lerp(L.colBot,L.dBot,t)};
        case 4:return{x:lerp(cx+(m-cx)*0.6,m,t),y:lerp(L.dBot,L.yLbl,t)};
        case 5:return{x:m,y:lerp(L.yLbl,L.ct2+L.bh2/2,t)};
        case 6:return{x:m,y:lerp(L.ct2+L.bh2/2,L.cereb+L.bh/2,t)};
        case 7:return{x:m,y:lerp(L.cereb+L.bh/2,L.res1,t)};
        case 8:return{x:m,y:lerp(L.res1,L.output,t)};
        case 9:return{x:m,y:lerp(L.output,L.output+20,t)};
        case 10:this.a=1-t;return{x:m,y:L.output+20+t*10};
        default:return{x:m,y:L.input};
      }
    }
    draw(L){const p=this.pos(L);ctx.beginPath();ctx.arc(p.x,p.y,this.sz,0,Math.PI*2);ctx.fillStyle=`rgba(${this.hue},${this.a*0.8})`;ctx.fill();ctx.beginPath();ctx.arc(p.x,p.y,this.sz*2.5,0,Math.PI*2);ctx.fillStyle=`rgba(${this.hue},${this.a*0.06})`;ctx.fill();}
  }
  class HopP{
    constructor(){this.reset();}
    reset(){this.t=Math.random();this.sp=0.004+Math.random()*0.003;this.ph=Math.random()>0.5?0:1;this.sz=1.3;}
    update(){this.t+=this.sp*speedMult;if(this.t>=1){this.t=0;this.ph=1-this.ph;}}
    draw(L){
      let x,y;const hcx=L.hx+L.hw/2,hcy=(L.colTop+L.colBot)/2;
      if(this.ph===0){x=lerp(L.br,hcx,this.t);y=lerp(L.router+L.bh,hcy-20,this.t);}
      else{x=lerp(hcx,L.br-4,this.t);y=lerp(hcy+20,(L.dTop+L.dBot)/2,this.t);}
      ctx.beginPath();ctx.arc(x,y,this.sz,0,Math.PI*2);
      ctx.fillStyle=`rgba(167,139,250,${0.5+Math.sin(this.t*Math.PI)*0.4})`;ctx.fill();
    }
  }
  class CTP{
    constructor(){this.reset();}
    reset(){this.t=Math.random();this.sp=0.004+Math.random()*0.003;this.sz=1.2;}
    update(){this.t+=this.sp*speedMult;if(this.t>=1)this.reset();}
    draw(L){
      const lx=L.fbLoopX,top=L.cxTop,bot=L.ct+L.bh/2;let x,y;
      if(this.t<0.2){x=lerp(L.bx,lx,this.t/0.2);y=bot;}
      else if(this.t<0.75){x=lx;y=lerp(bot,top,(this.t-0.2)/0.55);}
      else{x=lerp(lx,L.bx,(this.t-0.75)/0.25);y=top;}
      ctx.beginPath();ctx.arc(x,y,this.sz,0,Math.PI*2);
      ctx.fillStyle=`rgba(251,191,36,${0.5+Math.sin(this.t*Math.PI*2)*0.35})`;ctx.fill();
    }
  }

  const mainP=Array.from({length:32},()=>new MainP());
  const hpP=Array.from({length:7},()=>new HopP());
  const ctP=Array.from({length:5},()=>new CTP());

  let time=0;

  function draw(){
    time+=0.016;
    ctx.clearRect(0,0,W,H);
    const L=layout();
    const {bx,bw,bh,bh2,mx,br,hx,hw,skipX,uPathX,fbLoopX}=L;

    // Bg glow
    const g=ctx.createRadialGradient(mx,H*0.3,0,mx,H*0.3,W*0.6);
    g.addColorStop(0,'rgba(78,205,196,0.03)');g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g;ctx.fillRect(0,0,W,H);

    // ═══════════ INPUT ═══════════
    bar(bx,L.input-bh/2,bw,bh,CL.input,'x ∈ ℝᴮˣᵀˣᵈ  —  Input Sequence',9);
    cn(mx,L.input+bh/2,mx,L.norm-bh/2,CL.w+'0.1)');

    // ═══════════ RMSNORM ═══════════
    bar(bx,L.norm-bh/2,bw,bh,CL.norm,'RMSNorm   u = RMSNorm(x)',8.5);
    cn(mx,L.norm+bh/2,mx,L.neuro-bh/2-2,CL.w+'0.1)');

    // ═══════════ ① NEUROMODULATOR ═══════════
    bar(bx,L.neuro-bh/2,bw,bh+4,CL.neuro,'① NEUROMODULATOR   EMA(μ,σ²) · MLP(4d→3) · Sigmoid',8.5);
    lbl(br+6,L.neuro,'aux[nm]',CL.neuro.t,'left',5.5);

    // Signal dots
    const dDotX=mx-90, achDotX=mx, neDotX=mx+90;
    const sigData=[
      {lab:'σ_D',sub:'surprise',col:'#fb923c',x:dDotX},
      {lab:'σ_ACh',sub:'precision',col:'#4ecdc4',x:achDotX},
      {lab:'σ_NE',sub:'gain',col:'#f87171',x:neDotX}
    ];
    sigData.forEach((s,i)=>{
      const sy=L.sigs;
      const pr=4.5+Math.sin(time*2.5+i*2.1)*2;
      ctx.beginPath();ctx.arc(s.x,sy,pr,0,Math.PI*2);ctx.fillStyle=s.col+'44';ctx.fill();
      ctx.beginPath();ctx.arc(s.x,sy,3,0,Math.PI*2);ctx.fillStyle=s.col;ctx.fill();
      lbl(s.x,sy+13,s.lab,s.col+'cc','center',7);
      lbl(s.x,sy+23,s.sub,s.col+'77','center',5.5);
    });

    // ── σ_ACh → Predictive Coding (main flow center) ──
    cn(mx,L.sigs+28,mx,L.pred-bh/2-2,CL.w+'0.08)');
    lbl(mx+48,L.sigs+34,'σ_ACh →',CL.pred.t,'center',5.5);

    // ── σ_D → Router: from D dot, down vertically, then right into router bar ──
    cn(dDotX,L.sigs+8,dDotX,L.router,'rgba(251,146,60,0.22)',0.7,[2,4]);
    cn(dDotX,L.router,bx,L.router,'rgba(251,146,60,0.18)',0.7,[2,4]);
    arr(bx,L.router,'r',2.5,'rgba(251,146,60,0.3)');
    lbl(dDotX-12,(L.sigs+8+L.router)/2,'σ_D','rgba(251,146,60,0.4)','center',5.5);
    lbl(dDotX-12,(L.sigs+8+L.router)/2+10,'temp','rgba(251,146,60,0.3)','center',5);

    // ── σ_NE → NE Gain: from NE dot, right to br+6, down vertically, left into NE gain bar ──
    const nePathX=br+6;
    cn(neDotX,L.sigs+8,neDotX,L.sigs+28,'rgba(248,113,113,0.2)',0.7,[2,4]);
    cn(neDotX,L.sigs+28,nePathX,L.sigs+28,'rgba(248,113,113,0.18)',0.6,[2,4]);
    cn(nePathX,L.sigs+28,nePathX,L.neGain,'rgba(248,113,113,0.15)',0.7,[2,5]);
    cn(nePathX,L.neGain,br,L.neGain,'rgba(248,113,113,0.2)',0.7,[2,4]);
    arr(br,L.neGain,'l',2.5,'rgba(248,113,113,0.35)');
    ctx.save();ctx.translate(nePathX+10,(L.sigs+28+L.neGain)/2);ctx.rotate(-Math.PI/2);
    lbl(0,0,'σ_NE → gain','rgba(248,113,113,0.25)','center',5.5);
    ctx.restore();
    // NE particles along the path
    for(let i=0;i<3;i++){
      const t2=((time*0.12)+i*0.33)%1;
      const ny=lerp(L.sigs+28,L.neGain,t2);
      ctx.beginPath();ctx.arc(nePathX,ny,1.2,0,Math.PI*2);
      ctx.fillStyle=`rgba(248,113,113,${0.35+Math.sin(t2*Math.PI)*0.3})`;ctx.fill();
    }

    // ═══════════ ② PREDICTIVE CORTEX ═══════════
    bar(bx,L.pred-bh/2,bw,bh+2,CL.pred,'② PREDICTIVE CODING   û = u − (1−σ_ACh)·p̂',8.5);
    lbl(br+6,L.pred,'aux[pred]',CL.pred.t,'left',5.5);
    cn(mx,L.pred+bh/2+1,mx,L.pad-bh2/2-2,CL.w+'0.08)');

    // ═══════════ PAD & CHUNK ═══════════
    bar(bx,L.pad-bh2/2,bw,bh2,CL.pad,'Pad & Chunk → u_pad, u_chunks (B,nc,C,d), u_pool',7.5);
    cn(mx,L.pad+bh2/2,mx,L.router-bh/2-4,CL.w+'0.08)');

    // ═══════════ ③ THALAMIC ROUTER ═══════════
    bar(bx,L.router-bh/2-2,bw,bh+8,CL.router,'③ TOP-k ROUTING (D-modulated)   q·Kᵀ + topo 2D → top-k=4 of M=64',8.5);
    lbl(br+6,L.router,'aux[route]',CL.router.t,'left',5.5);

    // Router sub-labels
    if(showLabels){
      const ry=L.router+bh/2+8,subs=['2-D proximity bias','softmax(top-k)','k=4 of M=64'],sw=bw/3-6;
      subs.forEach((s,i)=>{const sx=bx+3+i*(sw+4);rr(sx,ry,sw,14,3);ctx.fillStyle='rgba(251,146,60,0.05)';ctx.fill();ctx.strokeStyle='rgba(251,146,60,0.18)';ctx.lineWidth=0.5;ctx.stroke();lbl(sx+sw/2,ry+7,s,'rgba(251,146,60,0.5)','center',5.5);});
    }

    // u_pool → Hopfield (horizontal right from router to Hopfield panel)
    cn(br,L.router,hx,L.router,'rgba(167,139,250,0.2)',0.8,[3,3]);
    lbl((br+hx)/2,L.router-8,'u_pool','rgba(167,139,250,0.4)','center',6);
    arr(hx-1,L.router,'r',3,'rgba(167,139,250,0.3)');

    // Router → Cortex
    cn(mx,L.router+bh/2+22,mx,L.cxTop,CL.w+'0.08)');
    arr(mx,L.cxTop,'d',3,CL.w+'0.15)');

    // ═══════════ ⑤ HOPFIELD (right panel) ═══════════
    const hfy1=L.router+28, hfy2=L.colBot+14;
    rr(hx,hfy1,hw,hfy2-hfy1,8);
    ctx.fillStyle=CL.hopf.f;ctx.fill();ctx.strokeStyle=CL.hopf.s;ctx.lineWidth=1;ctx.stroke();
    lbl(hx+hw/2,hfy1+14,'⑤ ASSOCIATIVE MEMORY',CL.hopf.t,'center',7);
    lbl(hx+hw/2,hfy1+28,'Hopfield Network',CL.hopf.t,'center',6.5);
    for(let s=0;s<5;s++){
      const sy=hfy1+48+s*((hfy2-hfy1-78)/5);
      const pr=3+Math.sin(time*1.6+s*1.3)*1.5;
      ctx.beginPath();ctx.arc(hx+hw/2-12,sy,pr,0,Math.PI*2);ctx.fillStyle=`rgba(167,139,250,${0.2+Math.sin(time*1.6+s*1.3)*0.15})`;ctx.fill();
      ctx.beginPath();ctx.arc(hx+hw/2-12,sy,2,0,Math.PI*2);ctx.fillStyle='rgba(167,139,250,0.6)';ctx.fill();
      lbl(hx+hw/2+4,sy,'Ξ'+s,'rgba(167,139,250,0.3)','left',5);
    }
    lbl(hx+hw/2,hfy2-16,'β=8 · 64 engrams','rgba(167,139,250,0.35)','center',5.5);

    // hpc_ctx → dendritic (from Hopfield panel bottom, down then left into dendritic bar)
    const hpcMid=(hfy2+L.dTop)/2;
    cn(hx+hw/2,hfy2,hx+hw/2,hpcMid,'rgba(167,139,250,0.18)',0.7,[3,3]);
    cn(hx+hw/2,hpcMid,br,(L.dTop+L.dBot)/2,'rgba(167,139,250,0.18)',0.7,[3,3]);
    arr(br,(L.dTop+L.dBot)/2,'l',3,'rgba(167,139,250,0.3)');
    lbl(hx+hw/2+8,hpcMid+8,'hpc_ctx','rgba(167,139,250,0.35)','left',5.5);
    lbl(br+5,(L.dTop+L.dBot)/2-8,'apical ↓','rgba(167,139,250,0.3)','left',5);

    // ═══════════ ④ CORTEX (container w/ sub-stages + columns) ═══════════
    rr(bx-4,L.cxTop,bw+8,L.cxBot-L.cxTop,10);
    ctx.fillStyle=CL.cortex.f;ctx.fill();ctx.strokeStyle=CL.cortex.s;ctx.lineWidth=1.2;ctx.stroke();
    lbl(bx+6,L.cxTop+10,'④ PARALLEL CORTEX','rgba(78,205,196,0.6)','left',7);

    // Sub-stage bars
    bar(bx+12,L.cxP1-bh2/2,bw-24,bh2,CL.cxSub,'Linear Projection → Gather k-of-M',7);
    cn(mx,L.cxP1+bh2/2,mx,L.cxP2-bh2/2-1,CL.w+'0.05)',0.5);
    bar(bx+12,L.cxP2-bh2/2,bw-24,bh2,CL.cxSub,'EI Gating (SST · PV · VIP interneurons)',7);
    cn(mx,L.cxP2+bh2/2,mx,L.cxP3-bh2/2-1,CL.w+'0.05)',0.5);
    bar(bx+12,L.cxP3-bh2/2,bw-24,bh2,CL.cxSub,'Adaptive Membrane + Causal Filtering',7);
    cn(mx,L.cxP3+bh2/2,mx,L.cxP4-bh2/2-1,CL.w+'0.05)',0.5);
    bar(bx+12,L.cxP4-bh2/2,bw-24,bh2,CL.cxSub,'Readout + PV Gate + D-Skip → weighted sum',7);

    // ── COLUMN VISUALIZATION ──
    for(let i=0;i<NCOLS;i++){
      const isA=ACTIVE.includes(i), cx=colX(i,L);
      cn(cx,L.cxP4+bh2/2+2,cx,L.colTop,isA?'rgba(251,146,60,0.3)':'rgba(255,255,255,0.04)',isA?1:0.5);
      if(isA)arr(cx,L.colTop,'d',2.5,'rgba(251,146,60,0.35)');
    }
    const cw=32, ch=L.colBot-L.colTop;
    for(let i=0;i<NCOLS;i++){
      const isA=ACTIVE.includes(i), cx=colX(i,L);
      rr(cx-cw/2,L.colTop,cw,ch,6);
      ctx.fillStyle=isA?'rgba(78,205,196,0.06)':'rgba(255,255,255,0.015)';ctx.fill();
      ctx.strokeStyle=isA?'rgba(78,205,196,0.35)':'rgba(255,255,255,0.06)';ctx.lineWidth=isA?1.2:0.5;ctx.stroke();
      if(isA){
        const gy=L.colTop+16;
        const es=3+Math.sin(time*3+i*1.5)*1.2;
        ctx.beginPath();ctx.arc(cx-6,gy,es,0,Math.PI*2);ctx.fillStyle=`rgba(52,211,153,${0.3+Math.sin(time*3+i)*0.18})`;ctx.fill();
        ctx.beginPath();ctx.arc(cx+6,gy,2.2,0,Math.PI*2);ctx.fillStyle=`rgba(239,68,68,${0.25+Math.sin(time*2.5+i*2)*0.18})`;ctx.fill();
        lbl(cx-6,gy+9,'E','rgba(52,211,153,0.45)','center',5);
        lbl(cx+6,gy+9,'I','rgba(239,68,68,0.4)','center',5);
        const ssmY=L.colTop+38, sH=16+Math.sin(time*2+i*0.7)*5;
        rr(cx-8,ssmY,16,sH,3);ctx.fillStyle=`rgba(78,205,196,${0.1+Math.sin(time*2+i)*0.05})`;ctx.fill();ctx.strokeStyle='rgba(78,205,196,0.2)';ctx.lineWidth=0.5;ctx.stroke();
        lbl(cx,ssmY+sH/2,'SSM','rgba(78,205,196,0.45)','center',5.5);
        const mY=ssmY+sH+10;
        ctx.beginPath();ctx.moveTo(cx-10,mY);for(let t=0;t<=1;t+=0.08)ctx.lineTo(cx-10+t*20,mY+Math.sin(t*Math.PI*3+time*3+i)*3);
        ctx.strokeStyle=`rgba(78,205,196,${0.3+Math.sin(time*1.5+i)*0.12})`;ctx.lineWidth=0.7;ctx.stroke();
        const vY=mY+14;
        ctx.beginPath();ctx.arc(cx,vY,3,0,Math.PI*2);ctx.fillStyle=`rgba(167,139,250,${0.28+Math.sin(time*2.2+i*1.7)*0.2})`;ctx.fill();
        lbl(cx,vY+9,'VIP','rgba(167,139,250,0.35)','center',5);
        const rY=L.colBot-18;
        rr(cx-8,rY,16,10,2);ctx.fillStyle='rgba(52,211,153,0.06)';ctx.fill();ctx.strokeStyle='rgba(52,211,153,0.2)';ctx.lineWidth=0.4;ctx.stroke();
        lbl(cx,rY+5,'Rₒ','rgba(52,211,153,0.4)','center',5);
      }
      lbl(cx,L.colBot+10,'C'+i,isA?'rgba(78,205,196,0.6)':'rgba(255,255,255,0.1)','center',7);
      if(isA){const rw=[0.45,0.30,0.25][ACTIVE.indexOf(i)];lbl(cx,L.colBot+20,'R='+rw.toFixed(2),'rgba(251,146,60,0.35)','center',5.5);}
    }
    cn(mx,L.cxBot,mx,L.dTop,CL.w+'0.08)');

    // ═══════════ ⑥ DENDRITIC READOUT ═══════════
    rr(bx-4,L.dTop,bw+8,L.dBot-L.dTop,10);
    ctx.fillStyle=CL.dend.f;ctx.fill();ctx.strokeStyle=CL.dend.s;ctx.lineWidth=1.2;ctx.stroke();
    lbl(bx+6,L.dTop+10,'⑥ DENDRITIC READOUT','rgba(196,181,253,0.55)','left',7);
    bar(bx+12,L.dN-bh2/2,bw-24,bh2,CL.dSub,'Two-Compartment Neuron   basal ⊙ (1 + plateau)',7);
    cn(mx,L.dN+bh2/2,mx,L.dL-bh2/2-1,CL.w+'0.05)',0.5);
    bar(bx+12,L.dL-bh2/2,bw-24,bh2,CL.dSub,'Lateral Cortical Propagation + hpc_ctx',7);
    cn(mx,L.dBot,mx,L.yLbl-6,CL.w+'0.08)');

    // ── y label ──
    lbl(mx,L.yLbl,'y (B, T, d)',CL.w+'0.5)','center',9);
    cn(mx,L.yLbl+8,mx,L.ct-bh/2-2,CL.w+'0.08)');

    // ═══════════ ⑦ CT FEEDBACK ═══════════
    bar(bx,L.ct-bh/2,bw,bh+2,CL.ctfb,'⑦ CT FEEDBACK   w\' = Softmax(l_topk + tanh(α_ct)·fb_sel)',8);
    cn(mx,L.ct+bh/2+1,mx,L.ct2-bh2/2-2,CL.w+'0.08)');
    bar(bx,L.ct2-bh2/2,bw,bh2,CL.ctpass,'Cortex (2nd pass, refined w\')   full re-run → y',7.5);

    // CT feedback loop (left side: from CT bar left edge, left to margin, up to cortex top, right back in)
    ctx.setLineDash([4,3]);ctx.beginPath();
    ctx.moveTo(bx,L.ct);ctx.lineTo(fbLoopX,L.ct);ctx.lineTo(fbLoopX,L.cxTop);ctx.lineTo(bx,L.cxTop);
    ctx.strokeStyle='rgba(251,191,36,0.22)';ctx.lineWidth=1.2;ctx.stroke();ctx.setLineDash([]);
    arr(bx-1,L.cxTop,'r',3,'rgba(251,191,36,0.3)');
    lbl(fbLoopX-10,(L.ct+L.cxTop)/2-4,'w\' → 2nd','rgba(251,191,36,0.3)','center',5.5);
    lbl(fbLoopX-10,(L.ct+L.cxTop)/2+6,'cortex pass','rgba(251,191,36,0.3)','center',5.5);

    cn(mx,L.ct2+bh2/2,mx,L.cereb-bh/2-4,CL.w+'0.08)');

    // ═══════════ ⑧ CEREBELLAR CORRECTOR ═══════════
    bar(bx,L.cereb-bh/2-2,bw,bh+6,CL.cereb,'⑧ CEREBELLAR CORRECTOR   z=SiLU(W_z·[u‖y])  Δ=einsum(z,V,U)  rank-r=8',8);

    // u path to cerebellum (left side: from norm bar left edge, out to left margin, down, back into cereb bar)
    cn(bx,L.norm,uPathX,L.norm,'rgba(34,211,238,0.15)',0.7,[2,5]);
    cn(uPathX,L.norm,uPathX,L.cereb,'rgba(34,211,238,0.15)',0.7,[2,5]);
    cn(uPathX,L.cereb,bx,L.cereb,'rgba(34,211,238,0.15)',0.7,[2,5]);
    arr(bx,L.cereb,'r',2.5,'rgba(34,211,238,0.3)');
    ctx.save();ctx.translate(uPathX-8,(L.norm+L.cereb)/2);ctx.rotate(-Math.PI/2);
    lbl(0,0,'u (from RMSNorm)','rgba(34,211,238,0.22)','center',5.5);
    ctx.restore();
    // u-path particles
    for(let i=0;i<3;i++){
      const t2=((time*0.1)+i*0.33)%1;
      ctx.beginPath();ctx.arc(uPathX,lerp(L.norm,L.cereb,t2),1.2,0,Math.PI*2);
      ctx.fillStyle=`rgba(34,211,238,${0.3+Math.sin(t2*Math.PI)*0.3})`;ctx.fill();
    }

    cn(mx,L.cereb+bh/2+4,mx,L.plus-10,CL.w+'0.08)');

    // ⊕ y + Δ
    ctx.beginPath();ctx.arc(mx,L.plus,10,0,Math.PI*2);ctx.fillStyle='rgba(34,211,238,0.06)';ctx.fill();ctx.strokeStyle='rgba(34,211,238,0.35)';ctx.lineWidth=1;ctx.stroke();
    lbl(mx,L.plus,'+','rgba(34,211,238,0.8)','center',10);
    lbl(mx+26,L.plus,'y + Δ',CL.w+'0.4)','left',7);
    cn(mx,L.plus+10,mx,L.neGain-bh/2-2,CL.w+'0.08)');

    // ═══════════ ⑨ NE GAIN ═══════════
    bar(bx,L.neGain-bh/2,bw,bh,CL.negain,'⑨ GLOBAL GAIN   y = y · (1 + r_NE·(2σ_NE − 1))',8.5);
    cn(mx,L.neGain+bh/2,mx,L.res1-bh2/2-2,CL.w+'0.08)');

    // ═══════════ BOTTOM PIPELINE ═══════════
    bar(bx,L.res1-bh2/2,bw,bh2,CL.resid,'(+) Residual + Dropout   x = x + drop(y + Δ)',7.5);
    cn(mx,L.res1+bh2/2,mx,L.norm2-bh2/2-2,CL.w+'0.06)');
    bar(bx,L.norm2-bh2/2,bw,bh2,CL.norm,'RMSNorm',7.5);
    cn(mx,L.norm2+bh2/2,mx,L.ffn-bh/2-2,CL.w+'0.06)');
    bar(bx,L.ffn-bh/2,bw,bh,CL.ffn,'SwiGLU Feed-Forward MLP   d_ff = 4·d',8);
    cn(mx,L.ffn+bh/2,mx,L.res2-bh2/2-2,CL.w+'0.06)');
    bar(bx,L.res2-bh2/2,bw,bh2,CL.resid,'(+) Residual + Dropout   x = x + drop(mlp(norm2(x)))',7.5);
    cn(mx,L.res2+bh2/2,mx,L.output-bh/2-2,CL.w+'0.08)');
    bar(bx,L.output-bh/2,bw,bh,CL.input,'x_out ∈ ℝᴮˣᵀˣᵈ  —  return x_out, aux_dict',9);

    // ═══════════ RESIDUAL SKIP x (left: norm → res1) ═══════════
    ctx.setLineDash([2,4]);ctx.beginPath();
    ctx.moveTo(skipX,L.norm+bh/2);ctx.lineTo(skipX-12,L.norm+bh/2);ctx.lineTo(skipX-12,L.res1);ctx.lineTo(skipX,L.res1);
    ctx.strokeStyle=CL.w+'0.1)';ctx.lineWidth=0.8;ctx.stroke();ctx.setLineDash([]);
    arr(skipX-1,L.res1,'r',2.5,CL.w+'0.15)');
    ctx.save();ctx.translate(skipX-22,(L.norm+L.res1)/2);ctx.rotate(-Math.PI/2);
    lbl(0,0,'RESIDUAL SKIP (x)',CL.w+'0.1)','center',5.5);
    ctx.restore();

    // ═══════════ PARTICLES ═══════════
    mainP.forEach(p=>{p.update();p.draw(L);});
    hpP.forEach(p=>{p.update();p.draw(L);});
    ctP.forEach(p=>{p.update();p.draw(L);});

    requestAnimationFrame(draw);
  }

  draw();

  window.toggleSpeed=function(){speedMult=speedMult===1?2:speedMult===2?0.5:1;document.getElementById('btnSpeed').textContent=speedMult+'× Speed';};
  window.toggleLabels=function(){showLabels=!showLabels;document.getElementById('btnLabels').classList.toggle('active',showLabels);};
})();
</script>

</body>
</html>
